---
title: "Utah TDS patterns by use and waterbody type"
author: "Jake Vander Laan"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Utah TDS}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette shows an example of using wqTools functions to extract and analyze statewide patterns of one water quality parameter, total dissolved solids.

```{r global_options, glb-opt, echo = FALSE}
options(width=500)
```

## Install and load Utah wqTools package
```{r, install}
#devtools::install_github("utah-dwq/wqTools")
library(wqTools)
```
<br>

## Read Utah monitoring locations
```{r, read-locations, results="hide"}

sites=readWQP(type="sites", statecode="US:49")
```
```{r, site-plot1, fig.height=5, fig.width=4.25}
plot(LatitudeMeasure~LongitudeMeasure, sites)
```

*Some wrong coordinates are present, let's get rid of those.*
```{r, site-plot2, fig.height=5, fig.width=4.25}
sites=subset(sites, LongitudeMeasure< -100)
plot(LatitudeMeasure~LongitudeMeasure, sites)
```
<br>
<br>


## Read all TDS data (2015-2018)
```{r, read-tds, results="hide"}
tds_sw=readWQP(type="result",
			  statecode="US:49",
			  characteristicName="Total dissolved solids",
			  start_date="01/01/2015", end_date="12/31/2018",
			  print=F)
```
<br>
<br>

## Check on units present in data
```{r unit-table}
knitr::kable(table(tds_sw$ProviderName, tds_sw$ResultMeasure.MeasureUnitCode), caption="Units present in TDS dataset.")
```
<br>
<br>

## Subset data to desired units
*Note:* A process for converting data to target units is potentially in the works. In this case, load based results are not appropriate anyway.
```{r, unit-subset}
dim(tds_sw)
tds_sw=subset(tds_sw, ResultMeasure.MeasureUnitCode=="mg/l")
dim(tds_sw)
```
<br>
<br>

## Fill non-detect values
*Note:* Tool in process. NAs not plotted here.
<br>
<br>

## Merge site locations to data
```{r, tds-site-merge}
tds_sites=merge(tds_sw, sites)
dim(tds_sites) #Note, some TDS records were not associated with a known site
```
<br>
<br>

#### TDS records w/o a site:
```{r, tds-no-site-table}
kableExtra::scroll_box(knitr::kable(subset(tds_sw,!MonitoringLocationIdentifier%in%sites$MonitoringLocationIdentifier)), width="100%", height="500px")
```
<br>
<br>

## Check site types present
```{r, site-types}
knitr::kable(table(droplevels(tds_sites$MonitoringLocationTypeName),tds_sites$ProviderName), caption="Site types present in TDS dataset")
```
<br>
<br>

## Lump canal types, subset to lakes, streams, and canals, 
```{r, subset-site-types}
dim(tds_sites)
levels(tds_sites$MonitoringLocationTypeName)=append(levels(tds_sites$MonitoringLocationTypeName),"Canal")
tds_sites$MonitoringLocationTypeName[tds_sites$MonitoringLocationTypeName %in% c("Canal Drainage","Canal Irrigation","Canal Transport")]="Canal"
tds_sites=subset(tds_sites, MonitoringLocationTypeName %in% c("River/Stream","Stream","Lake","Lake, Reservoir, Impoundment","Canal"))
dim(tds_sites)
knitr::kable(table(droplevels(tds_sites$MonitoringLocationTypeName),tds_sites$ProviderName), caption="Site types present in TDS dataset following subset to desired site types and grouping canals to single type.")
```
<br>

## Assign assessment units (& AU waterbody types)
```{r, assignAUs}
tds_sites=assignAUs(tds_sites)
knitr::kable(table(tds_sites$ProviderName, tds_sites$AU_Type), caption="AU types present in TDS dataset by database provider.")
```
<br>


## Assign beneficial uses
```{r, assignBUs}
tds_sites_uses=assignUses(tds_sites, flatten=T)
knitr::kable(table(tds_sites_uses$AU_Type, tds_sites_uses$BeneficialUse))  
```

*Flattening output so all uses can be plotted. Note that individual results are now duplicated when multiple uses apply to a site.*
<br>

## Build a map of all sites w/ TDS data
```{r, map1, fig.height=7, fig.width=7}
sites_w_tds=subset(sites, MonitoringLocationIdentifier %in% tds_sites$MonitoringLocationIdentifier) #Extract selected sites w/ TDS data 
buildMap(sites=sites_w_tds)
```
<br>

## Plot TDS by year & month
```{r tds-mo-yr, fig.height=4, fig.width=7}
tds_sites_uses=within(tds_sites_uses,{
	year=as.factor(lubridate::year(ActivityStartDate))
	month=as.factor(lubridate::month(ActivityStartDate))
})

boxplot(ResultMeasureValue~year,tds_sites_uses, ylab="TDS (mg/L)", xlab="Year")
boxplot(ResultMeasureValue~month,tds_sites_uses, ylab="TDS (mg/L)", xlab="Month")
```
<br>

Some of the really high values are probably coming from Great Salt Lake sampling sites. Let's remove those and try again.  

## Trim GSL sites
```{r trim-gsl, fig.height=4, fig.width=7}
dim(tds_sites_uses)
tds_sites_uses=subset(tds_sites_uses, !BeneficialUse %in% c("5A","5B","5C","5D","5E"))
dim(tds_sites_uses)
boxplot(ResultMeasureValue~year,tds_sites_uses, ylab="TDS (mg/L)", xlab="Year")
boxplot(ResultMeasureValue~month,tds_sites_uses, ylab="TDS (mg/L)", xlab="Month")
```

That looks better. Still some high values, but they appear to be coming from non-GSL waterbodies. Let's find these sites...
<br>

## Find sites w/ TDS values > 5000 recorded
```{r tds5000, map2, fig.height=7, fig.width=7}
tds_5000=subset(tds_sites_uses, ResultMeasureValue >=5000)
sites_tds_5000=subset(sites, MonitoringLocationIdentifier %in% tds_5000$MonitoringLocationIdentifier)
buildMap(sites=sites_tds_5000)
```
<br>

## Plot TDS by lat & long
```{r tds-lat-long, fig.height=4, fig.width=7}
par(mfrow=c(1,2))
plot(ResultMeasureValue~LongitudeMeasure, tds_sites_uses, xlab="Longitude (dd)", ylab="TDS (mg/L)", log='y')
plot(ResultMeasureValue~LatitudeMeasure, tds_sites_uses, xlab="Latitude (dd)", ylab="TDS (mg/L)", log='y')
```

*No obvious north/south or east/west patterns*

<br>

## Plot TDS by use
```{r tds-use, fig.height=4, fig.width=7}
boxplot(ResultMeasureValue~BeneficialUse, tds_sites_uses, ylab="TDS (mg/L)", log='y', xlab="Beneficial use class")

```
<br>

# Plot TDS by AU waterbody type
```{r tds-wbtype, fig.height=4, fig.width=7}
boxplot(ResultMeasureValue~AU_Type, tds_sites_uses, log='y', ylab="TDS (mg/L)", xlab="AU waterbody type")

```





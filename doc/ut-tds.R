## ----global_options, glb-opt, echo = FALSE------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
options(width=500)

## ---- install-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#devtools::install_github("utah-dwq/wqTools")
library(wqTools)

## ---- read-locations, results="hide"------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

sites=readWQP(type="sites", statecode="US:49")

## ---- site-plot1, fig.height=5, fig.width=4.25--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
plot(LatitudeMeasure~LongitudeMeasure, sites)

## ---- site-plot2, fig.height=5, fig.width=4.25--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
sites=subset(sites, LongitudeMeasure< -100)
plot(LatitudeMeasure~LongitudeMeasure, sites)

## ---- read-tds, results="hide"------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
tds_sw=readWQP(type="result",
			  statecode="US:49",
			  characteristicName="Total dissolved solids",
			  start_date="01/01/2015", end_date="12/31/2018",
			  print=F)

## ----unit-table---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
knitr::kable(table(tds_sw$ProviderName, tds_sw$ResultMeasure.MeasureUnitCode), caption="Units present in TDS dataset.")

## ---- unit-subset-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
dim(tds_sw)
tds_sw=subset(tds_sw, ResultMeasure.MeasureUnitCode=="mg/l")
dim(tds_sw)

## ---- tds-site-merge----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
tds_sites=merge(tds_sw, sites)
dim(tds_sites) #Note, some TDS records were not associated with a known site

## ---- tds-no-site-table-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
kableExtra::scroll_box(knitr::kable(subset(tds_sw,!MonitoringLocationIdentifier%in%sites$MonitoringLocationIdentifier)), width="100%", height="500px")

## ---- site-types--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
knitr::kable(table(droplevels(tds_sites$MonitoringLocationTypeName),tds_sites$ProviderName), caption="Site types present in TDS dataset")

## ---- subset-site-types-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
dim(tds_sites)
levels(tds_sites$MonitoringLocationTypeName)=append(levels(tds_sites$MonitoringLocationTypeName),"Canal")
tds_sites$MonitoringLocationTypeName[tds_sites$MonitoringLocationTypeName %in% c("Canal Drainage","Canal Irrigation","Canal Transport")]="Canal"
tds_sites=subset(tds_sites, MonitoringLocationTypeName %in% c("River/Stream","Stream","Lake","Lake, Reservoir, Impoundment","Canal"))
dim(tds_sites)
knitr::kable(table(droplevels(tds_sites$MonitoringLocationTypeName),tds_sites$ProviderName), caption="Site types present in TDS dataset following subset to desired site types and grouping canals to single type.")

## ---- assignAUs---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
tds_sites=assignAUs(tds_sites)
knitr::kable(table(tds_sites$ProviderName, tds_sites$AU_Type), caption="AU types present in TDS dataset by database provider.")

## ---- assignBUs---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
tds_sites_uses=assignUses(tds_sites, flatten=T)
knitr::kable(table(tds_sites_uses$AU_Type, tds_sites_uses$BeneficialUse))  

## ---- map1, fig.height=7, fig.width=7-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
sites_w_tds=subset(sites, MonitoringLocationIdentifier %in% tds_sites$MonitoringLocationIdentifier) #Extract selected sites w/ TDS data 
#buildMap(sites=sites_w_tds) #Build this locally

## ----tds-mo-yr, fig.height=4, fig.width=7-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
tds_sites_uses=within(tds_sites_uses,{
	year=as.factor(lubridate::year(ActivityStartDate))
	month=as.factor(lubridate::month(ActivityStartDate))
})

boxplot(ResultMeasureValue~year,tds_sites_uses, ylab="TDS (mg/L)", xlab="Year")
boxplot(ResultMeasureValue~month,tds_sites_uses, ylab="TDS (mg/L)", xlab="Month")

## ----trim-gsl, fig.height=4, fig.width=7--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
dim(tds_sites_uses)
tds_sites_uses=subset(tds_sites_uses, !BeneficialUse %in% c("5A","5B","5C","5D","5E"))
dim(tds_sites_uses)
boxplot(ResultMeasureValue~year,tds_sites_uses, ylab="TDS (mg/L)", xlab="Year")
boxplot(ResultMeasureValue~month,tds_sites_uses, ylab="TDS (mg/L)", xlab="Month")

## ----tds5000, map2, fig.height=7, fig.width=7---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
tds_5000=subset(tds_sites_uses, ResultMeasureValue >=5000)
sites_tds_5000=subset(sites, MonitoringLocationIdentifier %in% tds_5000$MonitoringLocationIdentifier)
#buildMap(sites=sites_tds_5000) #Build this locally

## ----tds-lat-long, fig.height=4, fig.width=7----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
par(mfrow=c(1,2))
plot(ResultMeasureValue~LongitudeMeasure, tds_sites_uses, xlab="Longitude (dd)", ylab="TDS (mg/L)", log='y')
plot(ResultMeasureValue~LatitudeMeasure, tds_sites_uses, xlab="Latitude (dd)", ylab="TDS (mg/L)", log='y')

## ----tds-use, fig.height=4, fig.width=7---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
boxplot(ResultMeasureValue~BeneficialUse, tds_sites_uses, ylab="TDS (mg/L)", log='y', xlab="Beneficial use class")


## ----tds-wbtype, fig.height=4, fig.width=7------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
boxplot(ResultMeasureValue~AU_Type, tds_sites_uses, log='y', ylab="TDS (mg/L)", xlab="AU waterbody type")


